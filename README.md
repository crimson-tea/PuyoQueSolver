# PuyoQueSolver
最大れんさを高速に計算するアプリケーションです。

## デモ動画
アップロード予定  

## PuyoQueSolver について
なぞる長さ(以下長さ)が5の場合、11924通りしかありません。  
これくらいならば全探索できますね。  
では、もっと長くなったときはどうなるでしょうか。  
より長いながさを現実的な時間で計算ができるようにビットボードでの高速化に挑戦しました。  
結果、素朴な int[][] での実装と比べ4-5倍ほどの高速化を達成し、長さ9までを0.5秒程度で計算することができました。(CPU: i7-12700 環境)  
※4-5倍程度の高速化は、長さを1長くしてもほぼ同等の計算時間であることを意味します。

## システム要件
* Windows 10 64ビット 以上
* .NET 6.0 以上
* AVX2 の利用が可能な CPU

## 使用言語、フレームワーク
* C# .NET 6.0 + WinForms

## 使い方
### 事前準備
#### githubのサイトを利用する方法
[このリポジトリ](https://github.com/crimson-tea/PuyoQueSolver)のコードをCode -> DownloadZipでダウンロードします。

ダウンロードしたファイルを展開します。

#### gitを利用する方法
以下のコマンドを実行します。
```
git clone https://github.com/crimson-tea/PuyoQueSolver.git
```

### Visual Studio 2022を利用して起動（簡単！）
`PuyoQueSolver.sln`ファイルを VisualStudio で開いてください。  
上部[ソリューション構成]リストボックスから Release を選択します。  
`Ctrl` + `F5`キーでアプリケーションが起動します。  

### コマンドを利用して起動
`PuyoQueSolver.csproj`が存在するディレクトリへ移動し、
```
dotnet run --project .\PuyoQueSolver\PuyoQueSolver\PuyoQueSolver.csproj --configuration Release
```
を実行してください。

起動後にエラーが表示されるので、exe ファイルのあるディレクトリに Releases からダウンロードした`patterns_1-x.msgpack`を置き、再度起動してください。

dotnet コマンドが利用できない方は[こちらのインストール方法](https://learn.microsoft.com/ja-jp/dotnet/core/install/windows?tabs=net70)をご確認ください。

デフォルトでは長さ5までの探索が有効です。  
Releases よりダウンロードすることで最大長さ10まで対応します。

## 工夫
1. 盤面をビットボードで表現しました。
    * AVX2 を活用しています。
2. 有効ななぞり方を重複無しで事前に列挙しました。

## ベンチマーク
環境  
CPU: i7-4790  
シングルスレッドにて計測  

|長さ|素朴な実装 処理時間(sec)|高速な実装 処理時間(sec)|
|---|---|---|
|5|0.0308|0.0167|
|6|0.1032|0.0808|
|7|2.1241|0.3686|
|8|8.1665|1.7098|

<Sub>※少々雑に計測していますが概ねの傾向はみて取れますね。</Sub>

## なぞる長さと有効ななぞり方の数
何の役に立つかわかりませんが置いておきます。
|なぞる長さ|有効ななぞり方|
|---|---|
|1|48|
|2|152|
|3|604|
|4|2631|
|5|11924|
|6|54788|
|7|249964|
|8|1118224|
|9|4862356|
|10|20401322|

## やりたいこと
現在は横型ビットボードで、各状態に ulong 変数一つを割り当てて実装している。  
これより効率の良いビットボードを実装する。  
縦型ビットボードにする。  
→ pext と pdep で効率よく落下をシミュレートできるはず。  
一つの ulong を1ビットに見立て3つのボードで8種類の状態を表現する。  
→ 省メモリになりコピーが高速になるはず。
